"use strict";function _classCallCheck(i,e){if(!(i instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(i,e){for(var t=0;t<e.length;t++){var s=e[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(i,s.key,s)}}function _createClass(i,e,t){return e&&_defineProperties(i.prototype,e),t&&_defineProperties(i,t),i}var client=require("./../client.js"),vector=require("../../../../lib/vector.js"),config=require("../../../../lib/config.js"),utils=require("../../../../lib/utils.js"),Ray=require("../../lib/ray.js"),Player=require("./player.js"),Zombie=require("./zombie.js"),Bullet=require("./bullet.js"),Barrier=require("./barrier.js"),Room=function(){function t(i,e){_classCallCheck(this,t),e=e||{},this.id=i,this.index=e.index,this.description=e.description,this.password=e.password,this.maxWave=e.maxWave,this.currentWave=e.currentWave,this.size=e.size,this.wallWidth=e.wallWidth,this.background=e.background,this.shadowColor="#28252b",this.localPlayer=null,this.players=[],this.zombies=[],this.bullets=[],this.barriers=[],this.sight=Ray.create(),this.sight.addBarrier(-this.size/2+this.wallWidth,-this.size/2+this.wallWidth,this.size/2-this.wallWidth,-this.size/2+this.wallWidth),this.sight.addBarrier(this.size/2-this.wallWidth,-this.size/2+this.wallWidth,this.size/2-this.wallWidth,this.size/2-this.wallWidth),this.sight.addBarrier(this.size/2-this.wallWidth,this.size/2-this.wallWidth,-this.size/2+this.wallWidth,this.size/2-this.wallWidth),this.sight.addBarrier(-this.size/2+this.wallWidth,this.size/2-this.wallWidth,-this.size/2+this.wallWidth,-this.size/2+this.wallWidth)}return _createClass(t,[{key:"render",value:function(i){i.rect(-this.size/2,-this.size/2,this.size,this.size,{fill:this.shadowColor});for(var e=0;e<this.barriers.length;e++){var t=this.barriers[e];i.camera.sees(t.position.x,t.position.y,t.width,t.height)&&t.render(i)}for(var s=this.sight.getShape(),e=0;e<s.length;e++)for(var r=s[e],l=0;l<s.length;l++){var a=s[l];if(r!==a)if(r.x>=a.x-1&&r.x<=a.x+1&&r.y>=a.y-1&&r.y<=a.y+1){s.splice(e,1);break}}i.save(),i.fromVertices(s,{fill:this.background,close:!0}),i.clip();for(e=0;e<this.bullets.length;e++){var h=this.bullets[e];i.camera.sees(h.position.x,h.position.y,h.radius,h.radius)&&h.render(i)}for(e=0;e<this.players.length;e++){var n=this.players[e];i.camera.sees(n.position.x,n.position.y,n.radius,n.radius)&&n.render(i)}for(e=0;e<this.zombies.length;e++){var o=this.zombies[e];i.camera.sees(o.position.x,o.position.y,o.radius,o.radius)&&o.render(i)}i.restore()}},{key:"update",value:function(){for(var i=0;i<this.players.length;i++)this.players[i].update();for(i=0;i<this.zombies.length;i++)this.zombies[i].update();for(i=0;i<this.bullets.length;i++)this.bullets[i].update();this.localPlayer&&(this.sight.position.x=this.localPlayer.position.x,this.sight.position.y=this.localPlayer.position.y,this.sight.cast())}},{key:"getPlayer",value:function(e){return this.players.find(function(i){return i.id===e})||null}},{key:"addPlayer",value:function(i,e){e=Player.create(i,e);return this.players.push(e),i===client.socket.id&&(this.localPlayer=e),e}},{key:"removePlayer",value:function(i){i=this.getPlayer(i);i&&this.players.splice(this.players.indexOf(i),1)}},{key:"getZombie",value:function(e){return this.zombies.find(function(i){return i.id===e})||null}},{key:"addZombie",value:function(i,e){e=Zombie.create(i,e);return this.zombies.push(e),e}},{key:"removeZombie",value:function(i){i=this.getZombie(i);i&&this.zombies.splice(this.zombies.indexOf(i),1)}},{key:"getBullet",value:function(e){return this.bullets.find(function(i){return i.id===e})||null}},{key:"addBullet",value:function(i,e){e=Bullet.create(i,e);return this.bullets.push(e),e}},{key:"removeBullet",value:function(i){i=this.getBullet(i);i&&this.bullets.splice(this.bullets.indexOf(i),1)}},{key:"getBarrier",value:function(e){return this.barriers.find(function(i){return i.id===e})||null}},{key:"addBarrier",value:function(i,e){for(var t=Barrier.create(i,e),s=0;s<t.vertices.length;s++){var r=t.vertices[s],l=t.vertices[s+1==t.vertices.length?0:s+1];this.sight.addBarrier(r.x,r.y,l.x,l.y)}return this.barriers.push(t),t}},{key:"removeBarrier",value:function(i){i=this.getBarrier(i);i&&this.barriers.splice(this.barriers.indexOf(i),1)}}]),t}();module.exports={create:function(i,e){return new Room(i,e)}};