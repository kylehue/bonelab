"use strict";function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,i){for(var t=0;t<i.length;t++){var s=i[t];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,i,t){return i&&_defineProperties(e.prototype,i),t&&_defineProperties(e,t),e}var vector=require("../../../lib/vector.js"),config=require("../../../lib/config.js"),utils=require("../../../lib/utils.js"),uuid=require("uuid"),closeObjects=[],Matter=require("matter-js"),Body=Matter.Body,Zombie=function(){function i(e){_classCallCheck(this,i),this.body=e,this.id=uuid.v4(),this.position=vector(),this.angle=utils.random(-Math.PI,Math.PI),this.fieldOfView=config.zombie.fieldOfView,this._nearestBarrierPoint=vector(),this._nearestBarrierLength=vector(),this._positionNext=vector(),this.lastAngleChange=Date.now(),this.angleChangeDelay=0,this.label="zombie",this.radius=config.zombie.radius,this.health=100}return _createClass(i,[{key:"addToQuadtree",value:function(e){e.insert({x:this.body.position.x-this.radius,y:this.body.position.y-this.radius,width:this.radius,height:this.radius,self:this})}},{key:"update",value:function(e){closeObjects=e.quadtree.retrieve({x:this.body.position.x-this.radius,y:this.body.position.y-this.radius,width:2*this.radius,height:2*this.radius}),Body.applyForce(this.body,this.body.position,{x:Math.cos(this.angle)*config.zombie.speed,y:Math.sin(this.angle)*config.zombie.speed}),this.position.set(this.body.position),this.handleBulletCollision(e),this.findTargets();for(var i=0;i<closeObjects.length;i++){var t=closeObjects[i].self;"barrier"===t.label&&(this.targetFound||Matter.SAT.collides(this.body,t.body).collided&&(this.angle+=utils.random([-Math.PI,Math.PI])*Math.random()))}this.health<=0&&e.removeZombie(this.id)}},{key:"handleBulletCollision",value:function(e){for(var i=0;i<closeObjects.length;i++){var t,s=closeObjects[i].self;"bullet"===s.label&&(t=this.position.dist(s.position),this.radius,s.radius,t<this.radius&&(this.health-=10,e.removeBullet(s.id)))}}},{key:"findTargets",value:function(){this.targetFound=!1;for(var e=0;e<closeObjects.length;e++){var i=closeObjects[e].self;"player"===i.label&&this.position.dist(i.position)<=this.fieldOfView.distance&&(this.angle=this.position.heading(i.position),this.targetFound=!0)}this.randomizeAngle()}},{key:"randomizeAngle",value:function(){var e=1200;Date.now()-this.lastAngleChange>this.angleChangeDelay?(this.angle+=utils.random(.2*-Math.PI,.2*Math.PI),this.lastAngleChange=Date.now(),this.angleChangeDelay=utils.random(600,e)):this.angleChangeDelay<900?this.angle+=utils.random(0,.05):900<this.angleChangeDelay&&(this.angle-=utils.random(0,.05))}},{key:"sees",value:function(e,i){i=i||0;var t=this.position.heading(e),e=this.position.dist(e);return t>this.angle-this.fieldOfView.angle/2&&t<this.angle+this.fieldOfView.angle/2&&e<this.fieldOfView.distance+i}}]),i}();module.exports={create:function(e){return new Zombie(e)}};