"use strict";function ownKeys(i,e){var r,t=Object.keys(i);return Object.getOwnPropertySymbols&&(r=Object.getOwnPropertySymbols(i),e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),t.push.apply(t,r)),t}function _objectSpread(i){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(i,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(r,e))})}return i}function _defineProperty(e,i,r){return i in e?Object.defineProperty(e,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[i]=r,e}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,i){for(var r=0;r<i.length;r++){var t=i[r];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(e,t.key,t)}}function _createClass(e,i,r){return i&&_defineProperties(e.prototype,i),r&&_defineProperties(e,r),e}var uuid=require("uuid"),config=require("../../../lib/config.js"),vector=require("../../../lib/vector.js"),utils=require("../../../lib/utils.js"),shape=require("../../../lib/shape.js"),Quadtree=require("@timohausmann/quadtree-js"),Player=require("./player.js"),Zombie=require("./zombie.js"),Bullet=require("./bullet.js"),Barrier=require("./barrier.js"),Matter=require("matter-js"),World=Matter.World,Engine=Matter.Engine,Bodies=Matter.Bodies,SAT=Matter.SAT,Room=function(){function r(e){var n=this;_classCallCheck(this,r),e=e||{},this.id=uuid.v4(),this.index=e.index||-1,this.description=e.description||"",this.password=e.password||"",this.maxWave=e.maxWave||0,this.currentWave=1,this.size=config.map.size||500,this.wallWidth=config.map.wallWidth,this.background=config.map.background||"#000",this.quadtree=new Quadtree({x:-this.size/2,y:-this.size/2,width:this.size,height:this.size}),this.engine=Engine.create(),this.world=this.engine.world,this.world.gravity.scale=0,this.players=[],this.zombies=[],this.bullets=[],this.barriers=[],this.addBarrier(0,-this.size/2+this.wallWidth/2,this.size,this.wallWidth),this.addBarrier(this.size/2-this.wallWidth/2,0,this.wallWidth,this.size),this.addBarrier(0,this.size/2-this.wallWidth/2,this.size,this.wallWidth),this.addBarrier(-this.size/2+this.wallWidth/2,0,this.wallWidth,this.size);for(var l,d=Math.pow(this.size,.6),i=(Date.now(),0);i<.02*this.size;i++)!function(){var r=n.getRandomPosition(),e=utils.random(config.barrier.min.width+d/2,config.barrier.max.width+d),i=utils.random(config.barrier.min.height+d/2,config.barrier.max.height+d),t=utils.random(.25*-Math.PI,.25*Math.PI);n.barriers.sort(function(e,i){return r.dist(i.position)-r.dist(e.position)});var s=n.barriers[0];s&&(t=s.angle+.25*Math.PI);var o=Bodies.rectangle(r.x,r.y,e,i,{angle:t});for(l=0;l<n.barriers.length;l++){var a=n.barriers[l];SAT.collides(o,a.body).collided&&(r=n.getRandomPosition(),e=utils.random(config.barrier.min.width+d/2,config.barrier.max.width+d),i=utils.random(config.barrier.min.height+d/2,config.barrier.max.height+d),n.barriers.sort(function(e,i){return r.dist(i.position)-r.dist(e.position)}),(s=n.barriers[0])&&(t=s.angle+.25*Math.PI),o=Bodies.rectangle(r.x,r.y,e,i,{angle:t}),l=-1)}n.addBarrier(r.x,r.y,e,i,{angle:t},!0)}();for(i=0;i<100;i++)this.addZombie()}return _createClass(r,[{key:"update",value:function(){Engine.update(this.engine);for(var e=0;e<this.players.length;e++)this.players[e].addToQuadtree(this.quadtree);for(e=0;e<this.zombies.length;e++)this.zombies[e].addToQuadtree(this.quadtree);for(e=0;e<this.bullets.length;e++)this.bullets[e].addToQuadtree(this.quadtree);for(e=0;e<this.barriers.length;e++)this.barriers[e].addToQuadtree(this.quadtree);for(e=0;e<this.players.length;e++)this.players[e].update(this);for(e=0;e<this.zombies.length;e++)this.zombies[e].update(this);for(e=0;e<this.bullets.length;e++)this.bullets[e].update(this);for(e=0;e<this.barriers.length;e++)this.barriers[e].update(this);this.quadtree.clear()}},{key:"getPlayer",value:function(i){return this.players.find(function(e){return e.id===i})}},{key:"addPlayer",value:function(e){for(var i=this.getRandomPosition(),r=config.player.radius,t=config.player.body,s=Bodies.circle(i.x,i.y,r,t),o=Player.create(e,s),a=0;a<this.barriers.length;a++){var n=this.barriers[a];SAT.collides(s,n.body).collided&&(i=this.getRandomPosition(),r=config.player.radius,t=config.player.body,s=Bodies.circle(i.x,i.y,r,t),o=Player.create(e,s),a=-1)}return World.add(this.world,s),this.players.push(o),o}},{key:"removePlayer",value:function(e){e=this.getPlayer(e);e&&(World.remove(this.world,e.body),this.players.splice(this.players.indexOf(e),1))}},{key:"getZombie",value:function(i){return this.zombies.find(function(e){return e.id===i})}},{key:"addZombie",value:function(){for(var e=this.getRandomPosition(),i=config.zombie.radius,r=config.zombie.body,t=Bodies.circle(e.x,e.y,i,r),s=Zombie.create(t),o=0;o<this.barriers.length;o++){var a=this.barriers[o];SAT.collides(t,a.body).collided&&(e=this.getRandomPosition(),i=config.zombie.radius,r=config.zombie.body,t=Bodies.circle(e.x,e.y,i,r),s=Zombie.create(t),o=-1)}return World.add(this.world,t),this.zombies.push(s),s}},{key:"removeZombie",value:function(e){e=this.getZombie(e);e&&(World.remove(this.world,e.body),this.zombies.splice(this.zombies.indexOf(e),1))}},{key:"getBullet",value:function(i){return this.bullets.find(function(e){return e.id===i})}},{key:"addBullet",value:function(e,i){i=Bullet.create(e,i);return this.bullets.push(i),i}},{key:"removeBullet",value:function(e){e=this.getBullet(e);e&&this.bullets.splice(this.bullets.indexOf(e),1)}},{key:"getBarrier",value:function(i){return this.barriers.find(function(e){return e.id===i})}},{key:"addBarrier",value:function(e,i,r,t,s,o){s=o?_objectSpread(_objectSpread({},config.barrier.body),s):s||config.barrier.body;t=Bodies.rectangle(e,i,r,t,s),s=Barrier.create(t);return World.add(this.world,t),this.barriers.push(s),s}},{key:"removeBarrier",value:function(e){e=this.getBarrier(e);e&&(World.remove(this.world,e.body),this.barriers.splice(this.barriers.indexOf(e),1))}},{key:"getRandomPosition",value:function(){var e=utils.random(-this.size/2,this.size/2),i=utils.random(-this.size/2,this.size/2);return vector(e,i)}}]),r}();module.exports={create:function(e){return new Room(e)}};